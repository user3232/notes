
# References

1. RFC5280 - definition of x509 certificate structure and elements
2. RFC3647 - definition of Certificate Practice Statement (CPS)
3. OpenSSL manual -maping of x509 certificate elements to nicer
   names and producing certificates from CLI and conf files.
4. http://www.oid-info.com/ - registered Object Identifiers (OIDs)
   search


# x509 certificate

x509 standard can be found at: https://tools.ietf.org/html/rfc5280

The extensions defined for X.509v3 certificates provide methods for
associating additional attributes with users or public keys and for
managing relationships between CAs.

The X.509v3 certificate format also allows communities to define
private extensions to carry information unique to those communities.

## critical or non-critical extension

Each Certificate Extensions in a certificate is designated as either
critical or non-critical. A certificate-using system MUST reject the
certificate if it encounters a critical extension it does not
recognize or a critical extension that contains information that it
cannot process.

A non-critical extension MAY be ignored if it is not recognized, but
MUST be processed if it is recognized. 

## Certificate Extensions usage

The following sections present recommended extensions used within
Internet certificates and standard locations for information.
Communities may elect to use additional extensions; however, caution
ought to be exercised in adopting any critical extensions in
certificates that might prevent use in a general context.

Each extension includes an OID and an ASN.1 structure. When an
extension appears in a certificate, the OID appears as the field
extnID and the corresponding ASN.1 DER encoded structure is the value
of the octet string extnValue. A certificate MUST NOT include more
than one instance of a particular extension.

For example, a certificate may contain only one authority key
identifier extension (Section 4.2.1.1). An extension includes the
boolean critical, with a default value of FALSE. The text for each
extension specifies the acceptable values for the critical field for
CAs conforming to this profile.

Conforming CAs MUST support Certificate Extensions:

- key identifiers - 
  - Authority Key Identifier (Sections 4.2.1.1)
  - and Subject Key IDentifier (Sections 4.2.1.2)
- basic constraints (Section 4.2.1.9)
- key usage (Section 4.2.1.3)
- certificate policies (Section 4.2.1.4)) 

If the CA issues certificates with an empty sequence for the subject
field, the CA MUST support:
- the subject alternative name extension (Section 4.2.1.6). 
- Support for the remaining extensions is OPTIONAL.

Conforming CAs MAY support extensions that are not identified within
this specification; certificate issuers are cautioned that marking
such extensions as critical may inhibit interoperability.

At a minimum, applications conforming to this profile MUST recognize
the following extensions:

- KeyUsage (Section 4.2.1.3)
- certificatePolicies (Section 4.2.1.4)
- Subject Alternative Name (Section 4.2.1.)
- basicConstraints (Section 4.2.1.9)
- nameConstraints (Section 4.2.1.10)
- policyConstraints (Section 4.2.1.11)
- extendedKeyUsage (Section 4.2.1.12)
- inhibitAnyPolicy (Section 4.2.1.14). 

In addition, applications conforming to this profile SHOULD recognize
following extensions:
- the authority identifier (Sections 4.2.1.1)
- the subject key identifier (4.2.1.2) 
- and policy mappings ([Section
  4.2.1.5](https://tools.ietf.org/html/rfc5280#section-4.2.1.5))


# x509v3 Structure


```sql

Certificate             ::=  SEQUENCE  {
  tbsCertificate        TBSCertificate,
  signatureAlgorithm    AlgorithmIdentifier,
                  -- shold be same as tbsCertificate::signature
  signatureValue        BIT STRING  
                  -- product of pure function:
                  -- sign(
                  --   priv_key, 
                  --   signatureAlgorithm, 
                  --   'ASN.1 DER encoded' (tbsCertificate)
                  -- ) --> res
                  -- 'encoded as a BIT STRING'(res) -> signatureValue
}

TBSCertificate          ::=  SEQUENCE  {
  version         [0]   EXPLICIT Version DEFAULT v1,
                  -- version of certificate structure
  serialNumber          CertificateSerialNumber,
                  -- The serial number MUST be a positive integer 
                  -- assigned by the CA to each certificate.  
                  -- It MUST be unique for each certificate issued by a
                  -- given CA.
                  -- 2 things identify a unique certificate:
                  --   the issuer name and 
                  --   serial number 
                  -- CAs MUST force the serialNumber to be a 
                  -- non-negative integer.

  signature             AlgorithmIdentifier,
                  -- This field contains the algorithm identifier for the
                  -- algorithm used by the CA to sign the certificate.
                  -- Following MUST equal:
                  --   aCertificate::tbsCertificate::signature
                  --   aCertificate::signatureAlgorithm
  issuer                Name,
                  -- The issuer field MUST contain a non-empty distinguished
                  -- name (DN).
                  -- The Name describes a hierarchical name composed of 
                  -- attributes, such as:
                  --   * country,
                  --   * organization,
                  --   * organizational unit,
                  --   * distinguished name qualifier,
                  --   * state or province name,
                  --   * common name (e.g., "Susan Housley"), and
                  --   * serial number.
                  -- and associated values.
  validity              Validity,
                  -- The certificate validity period is the time interval
                  -- during which the CA warrants that it will maintain 
                  -- information about the status of the certificate.
                  -- It is SEQUENCE of two dates:
                  --   * notBefore
                  --   * notAfter
  subject               Name,
                  -- DN of subject.
                  -- * For non CA cert The subject name MAY be carried in  
                  --   * the subject field and/or 
                  --   * the subjectAltName extension.
                  -- * For non CA cert with empty subject, subjectAltName 
                  --   extension MUST be critical.
                  -- * For CA cert 
                  --   * subject field MUST be populated with a non-empty
                  --     distinguished name 
                  --   * issued certificates MUST have issuer name 
                  --     matching this (CA) subject name
                  -- * The DN MUST be unique for each subject entity 
                  --   certified by the one CA as defined by the issuer 
                  --   field.  
                  -- * A CA MAY issue more than one certificate 
                  --   with the same DN to the same subject entity.
  subjectPublicKeyInfo  SubjectPublicKeyInfo,
                  -- carry the public key and identify the algorithm
                  -- with which the key is used
  issuerUniqueID  [1]   IMPLICIT UniqueIdentifier OPTIONAL,
                  -- * If present, version MUST be v2 or v3
                  -- * issuer unique identifier is present 
                  --   in the certificate to handle the possibility of
                  --   reuse of issuer name over time
                  -- * rfc5280 recommends:
                  --   * that names not be reused for different entities 
                  --   * that Internet certificates not make use of
                  --   * there are no processing requirements associated  
                  --     with the unique identifier
  subjectUniqueID [2]   IMPLICIT UniqueIdentifier OPTIONAL,
                  -- If present, version MUST be v2 or v3
                  -- * subject unique identifier is present in the 
                  --   certificate to handle the possibility of 
                  --   reuse of subject name over time
                  -- * rfc5280 recommends:
                  --   * that names not be reused for different entities 
                  --   * that Internet certificates not make
                  --   * there are no processing requirements associated  
                  --     with the unique identifier
  extensions      [3]   EXPLICIT Extensions OPTIONAL
                  -- If present, version MUST be v3
                  -- The extensions defined for X.509 v3 certificates
}
Version                 ::=  INTEGER  {  v1(0), v2(1), v3(2)  }
CertificateSerialNumber ::=  INTEGER
Validity                ::= SEQUENCE {
  notBefore             Time,
  notAfter              Time 
}
Time ::= CHOICE {
  utcTime               UTCTime,
  generalTime           GeneralizedTime 
}
UniqueIdentifier        ::=  BIT STRING
SubjectPublicKeyInfo    ::=  SEQUENCE  {
  algorithm             AlgorithmIdentifier,
  subjectPublicKey      BIT STRING  
}
Extensions              ::=  SEQUENCE SIZE (1..MAX) OF Extension
Extension               ::=  SEQUENCE  {
  extnID                OBJECT IDENTIFIER,
  critical              BOOLEAN DEFAULT FALSE,
  extnValue             OCTET STRING
                  -- contains the DER encoding of an ASN.1 value
                  -- corresponding to the extension type identified
                  -- by extnID
}
AlgorithmIdentifier     ::=  SEQUENCE  {
  algorithm             OBJECT IDENTIFIER,
                  -- identifies for ex RSA with SHA-256
  parameters            ANY DEFINED BY algorithm OPTIONAL  
}
```

# x509v3 Standard Extensions Structure


```sql
-- x509v3 certificate can have sequence of extensions
-- every extension have structure identifying extension
-- type, if it should be treated as mandatory for validation
-- and extension type particular value.
-- 
--   * Every extension type starts with oid 2.5.29
--   * OIDs allaws for defining new extension types
--   * and communication of those using global registry (OID registry).
Extensions              ::=  SEQUENCE SIZE (1..MAX) OF Extension
Extension               ::=  SEQUENCE  {
  extnID                OBJECT IDENTIFIER,
  critical              BOOLEAN DEFAULT FALSE,
  extnValue             OCTET STRING
                        -- contains the DER encoding of an ASN.1 value
                        -- corresponding to the extension type identified
                        -- by extnID
}
id-ce   OBJECT IDENTIFIER ::=  { joint-iso-ccitt(2) ds(5) 29 }
                        -- extensions id prefix 2.5.29
                        -- https://www.alvestrand.no/objectid/2.5.29.html 
```

## Authority key identifier (oid 2.5.29.35)

```sql
-- Authority key identifier (oid 2.5.29.35)
--   * Used to help to point to parent in certificate chain
--   * Use is not mandatory but recommended, when used
--     signed (child) certificates schould use this subject key 
--     identifier as issuer key identifier.
--   * Self signed certificate may not use it, as it is the same as
--     subject key identifier (which is mandatory).
--   * Issuer key identifier should be generated from issuer: 
--     * subject key identifier if not empty, otherwise from
--     * public key if issuer subject key identifier is empty, 
--       or alternatively from
--     * issuer subject name and serialNumber if issuer subject key 
--       identifier is empty.
--   * If client is not able to find proper certificate chain using
--     key identifiers, it should try other ways => key identifiers 
--     may be broken.
id-ce-authorityKeyIdentifier OBJECT IDENTIFIER ::=  { id-ce 35 }
                                                    -- 2.5.29.35
-- Conforming CAs MUST mark this extension as non-critical.
AuthorityKeyIdentifier ::= SEQUENCE {
  keyIdentifier             [0] KeyIdentifier           OPTIONAL,
  authorityCertIssuer       [1] GeneralNames            OPTIONAL,
  authorityCertSerialNumber [2] CertificateSerialNumber OPTIONAL  
}
KeyIdentifier ::= OCTET STRING
```

## Subject Key Identifier (oid 2.5.29.14)


```sql
-- Subject Key Identifier (oid 2.5.29.14)
--   * It is some digest of certificate (embedded) public key
--   * It is used for grouping certificates using same public key
--   * If certificate is CA certificate Subject Key Identifier is
--     mandatory
--   * Conforming CAs MUST mark this extension as non-critical.
--     (errors don't imply invalidity)
id-ce-subjectKeyIdentifier OBJECT IDENTIFIER ::=  { id-ce 14 }
                                                  -- 2.5.29.14
SubjectKeyIdentifier ::= KeyIdentifier
```


## Key Usage (oid 2.5.29.15)

```sql
-- Key Usage 
id-ce-keyUsage OBJECT IDENTIFIER ::=  { id-ce 15 }
                -- 2.5.29.15
                -- if the keyUsage extension is present, then
                --   * the subject public key MUST NOT be used to verify 
                --     signatures on certificates or CRLs **unless** 
                --       * keyCertSign or cRLSign bit is set.

KeyUsage ::= BIT STRING {
  digitalSignature        (0),
                  -- subject public key is used for verifying 
                  -- digital signatures, other than signatures on 
                  -- certificates (bit 5) and CRLs (bit 6). E.g.:
                  --   * entity authentication service, 
                  --   * a data origin authentication service
  nonRepudiation          (1), 
                  -- * recent editions of X.509 have
                  --   renamed this bit to contentCommitment.
                  -- * certificate used for validation of data 
                  --   (as digitalSignature)
                  -- * Declares that usage certificate of this type
                  --   Entity giving such cert gives low to 
                  --   expect that every data with matching signature
                  --   is at the responsibility of signer
  keyEncipherment         (2),
                  -- subject public key is used for 
                  -- enciphering private or secret keys. e.g.:
                  --   * RSA public key is to be used for encrypting 
                  --     a symmetric content-decryption key.
  dataEncipherment        (3),
                  -- subject public key is used for directly enciphering 
                  -- raw user data without the use of an intermediate 
                  -- symmetric cipher.
                  --   * uncommon
  keyAgreement            (4),
                  -- subject public key is used for key agreement. E.g.: 
                  --   * when a Diffie-Hellman key is to be used 
                  --     for key management
  keyCertSign             (5),
                  -- subject public key is used for verifying signatures
                  -- on public key certificates.
                  --   * CA bit MUST also be asserted
  cRLSign                 (6),
                  -- subject public key is used for verifying signatures
                  -- on certificate revocation lists
  encipherOnly            (7),
                  --   * if keyAgreement not set => undefined
                  --   * if keyAgreement set => subject public key may
                  --     be used only for enciphering data while 
                  --     performing key agreement
  decipherOnly            (8) 
                  --   * if keyAgreement not set => undefined
                  --   * if keyAgreement set => subject public key may
                  --     be used only for deciphering data while 
                  --     performing key agreement
}
```

## Certificate Policies (2.5.29.32)


```sql
-- Certificate Policies (oid )
id-ce-certificatePolicies OBJECT IDENTIFIER ::=  { id-ce 32 }
            -- 2.5.29.32
anyPolicy OBJECT IDENTIFIER ::= { id-ce-certificatePolicies 0 }
            -- 2.5.29.32.0
            -- * it is meaningfull in CA certificate
            -- * this is special identifier meaning
            --   that cert declares that it wish
            --   not to restrict polices in a chain 
certificatePolicies ::= SEQUENCE SIZE (1..MAX) OF PolicyInformation
            -- container for policies
            -- * In an end entity certificate, these policy 
            --   information terms indicate: 
            --   * the policy under which the certificate has been issued 
            --   * and the purposes for which the certificate may be used.
            -- * In a CA certificate, these policy information terms:
            --   * limit the set of policies for certification paths that 
            --     include this certificate
            --   * When a CA does not wish to limit the set of policies 
            --     for certification paths that include this certificate, 
            --     it MAY assert the special policy anyPolicy,
            --     (with a value of { 2 5 29 32 0 })
PolicyInformation ::= SEQUENCE {
  policyIdentifier   CertPolicyId,
            -- * any oid can be used for specified policy
            -- * A certificate policy OID MUST NOT appear 
            --   more than once in a certificate policies 
            --   extension.
  policyQualifiers   SEQUENCE SIZE (1..MAX) OF PolicyQualifierInfo OPTIONAL 
            -- Optional qualifiers, which MAY be present, 
            -- are not expected to change the definition 
            -- of the policy.!!!!!
}
CertPolicyId ::= OBJECT IDENTIFIER
            -- certificate policy oid can be any oid
PolicyQualifierInfo ::= SEQUENCE {
            -- policy can have some additional info
            -- id should not change meaning of policy!!!
  policyQualifierId  PolicyQualifierId,
            -- info type
  qualifier          ANY DEFINED BY policyQualifierId 
            -- info type value
}
id-qt          OBJECT IDENTIFIER ::=  { id-pkix 2 }
            -- 1.3.6.1.5.5.7.2
            -- policyQualifierIds for 
            -- Internet policy qualifiers
            -- iso(1) identified-organization(3) dod(6)
            -- internet(1) security(5) mechanisms(5) 
            -- pkix(7) qt(2)
id-qt-cps      OBJECT IDENTIFIER ::=  { id-qt 1 }
            -- 1.3.6.1.5.5.7.2.1
id-qt-unotice  OBJECT IDENTIFIER ::=  { id-qt 2 }
            -- 1.3.6.1.5.5.7.2.2
PolicyQualifierId ::= OBJECT IDENTIFIER ( id-qt-cps | id-qt-unotice )
            -- PolicyQualifierId for Internet policy qualifiers:
            --   * 1.3.6.1.5.5.7.2.1
            --   * 1.3.6.1.5.5.7.2.2
Qualifier ::= CHOICE {
            -- types matching particular policyQualifierId
  cPSuri          CPSuri,
            -- URI ??
  userNotice      UserNotice 
            -- text to display?
}
CPSuri ::= IA5String
            -- URI as some string?
UserNotice ::= SEQUENCE {
            -- text to display with URL
  noticeRef        NoticeReference OPTIONAL,
            -- URL?
  explicitText     DisplayText OPTIONAL 
            -- text
}
NoticeReference ::= SEQUENCE {
  organization     DisplayText,
            -- organization name to display
  noticeNumbers    SEQUENCE OF INTEGER 
            -- this text reference number
}
DisplayText ::= CHOICE {
                    -- text to display can be of various type
                    -- but up to 200 characters
  ia5String         IA5String      (SIZE (1..200)),
  visibleString     VisibleString  (SIZE (1..200)),
  bmpString         BMPString      (SIZE (1..200)),
  utf8String        UTF8String     (SIZE (1..200)) 
}

```


## Policy Mappings (oid 2.5.29.33)


```sql
id-ce-policyMappings OBJECT IDENTIFIER ::=  { id-ce 33 }
              -- * oid: 2.5.29.33
              --   {
              --      joint-iso-itu-t(2) 
              --      ds(5) 
              --      certificateExtension(29) 
              --      policyMappings(33)
              --   }
              -- * used in CA certificates
              --   This extension MAY be supported by CAs 
              --   and/or applications.
PolicyMappings ::= SEQUENCE SIZE (1..MAX) OF SEQUENCE {
              -- * It lists one or more pairs of OIDs; 
              --   each pair includes: an issuerDomainPolicy and a
              --   subjectDomainPolicy.
              -- * The pairing indicates the issuing CA considers
              --   its issuerDomainPolicy equivalent to the subject
              --   CA's subjectDomainPolicy.
              -- * Each issuerDomainPolicy named in the policy mappings 
              --   extension SHOULD also be asserted in a certificate 
              --   policies extension in the same certificate.  
              -- * Policies MUST NOT be mapped either to or from the
              --   special value anyPolicy.
  issuerDomainPolicy      CertPolicyId,
  subjectDomainPolicy     CertPolicyId 
}
```



## Subject Alternative Name (oid 2.5.29.17)

The subject alternative name extension allows identities to be bound
to the subject of the certificate.  These identities may be included
in addition to or in place of the identity in the subject field of the
certificate.

- Defined options include:
  - Multiple name forms, and multiple instances of each name form, MAY
    be included.
  - an Internet electronic mail address
    - When the subjectAltName extension contains an Internet mail
      address, the address MUST be stored in the rfc822Name.  The
      format of an rfc822Name is a "Mailbox"
  - a DNS name, 
    - DNS name MAY also be represented in the subject field using the
      domainComponent attribute
    - When the subjectAltName extension contains a domain name system
      label, the domain name MUST be stored in the dNSName (an
      IA5String). The name MUST be in the "preferred name syntax", as
      specified by Section 3.5 of [RFC1034] and as modified by Section
      2.1 of [RFC1123].
  - an IP address, 
    - the address MUST be stored in the octet string in "network byte
      order", as specified in [RFC791].  The least significant bit
      (LSB) of each octet is the LSB of the corresponding byte in the
      network address.  For IP version 4, as specified in [RFC791],
      the octet string MUST contain exactly four octets.  For IP
      version 6, as specified in [RFC2460], the octet string MUST
      contain exactly sixteen octets.
  - a Uniform Resource Identifier (URI)
    - the name MUST be stored in the uniformResourceIdentifier (an
      IA5String).  The name MUST NOT be a relative URI, and it MUST
      follow the URI syntax and encoding rules specified in [RFC3986].
      The name MUST include both a scheme (e.g., "http" or "ftp") and
      a scheme-specific-part.  URIs that include an authority
      ([RFC3986], Section 3.2) MUST include a fully qualified domain
      name or IP address as the host.
- Other options exist, including completely local definitions.
  - The subjectAltName MAY carry additional name types through the use
    of the otherName field.  The format and semantics of the name are
    indicated through the OBJECT IDENTIFIER in the type-id field.  The
    name itself is conveyed as value field in otherName.  For example,
    Kerberos [RFC4120] format names can be encoded into the otherName,
    using a Kerberos 5 principal name OID and a SEQUENCE of the Realm
    and the PrincipalName.
- CAs:
  - Because the subject alternative name is considered to be definitively
    bound to the public key, all parts of the subject alternative name
    MUST be verified by the CA.
  - Further, if the only subject identity included in the certificate is
    an alternative name form (e.g., an electronic mail address), then the
    subject distinguished name MUST be empty (an empty sequence), and the
    subjectAltName extension MUST be present.
  - If the subject field contains an empty sequence, then the issuing CA
    MUST include a subjectAltName extension that is marked as critical.
  - When including the subjectAltName extension in a certificate that
    has a non-empty subject distinguished name, conforming CAs SHOULD
    mark the subjectAltName extension as non-critical.
  - Subject alternative names MAY be constrained in the same manner as
    subject distinguished names using the name constraints extension





```sql
id-ce-subjectAltName OBJECT IDENTIFIER ::=  { id-ce 17 }
                                            -- 2.5.29.17
SubjectAltName ::= GeneralNames
                  -- type associated with id-ce-subjectAltName
GeneralNames ::= SEQUENCE SIZE (1..MAX) OF GeneralName
                  -- container
GeneralName ::= CHOICE {
  otherName                       [0]     OtherName,
                  -- other name schemes can be used by
                  -- specifying oid and its associated
                  -- type
  rfc822Name                      [1]     IA5String,
                  -- email
  dNSName                         [2]     IA5String,
                  -- DNS
  x400Address                     [3]     ORAddress,
  directoryName                   [4]     Name,
                  -- ?
  ediPartyName                    [5]     EDIPartyName,
  uniformResourceIdentifier       [6]     IA5String,
                  -- URI
  iPAddress                       [7]     OCTET STRING,
                  -- IPv4 | IPv6
  registeredID                    [8]     OBJECT IDENTIFIER 
}

OtherName ::= SEQUENCE {
                  -- for specifying name schema and its value
  type-id    OBJECT IDENTIFIER,
  value      [0] EXPLICIT ANY DEFINED BY type-id 
}
EDIPartyName ::= SEQUENCE {
                  -- what is this ....
  nameAssigner            [0]     DirectoryString OPTIONAL,
  partyName               [1]     DirectoryString 
}

```

## Issuer Alternative Name (oid 2.5.29.18)

this extension is used to associate Internet style identities with the
certificate issuer.  Issuer alternative name MUST be encoded as in
Subject Alternative Name of issuing certificate.

Issuer alternative names are not processed as part of the
certification path validation algorithm.

Where present, conforming CAs SHOULD mark this extension as non-
critical.

```sql
id-ce-issuerAltName OBJECT IDENTIFIER ::=  { id-ce 18 }
IssuerAltName ::= GeneralNames
```


## Subject Directory Attributes (oid 2.5.29.9)

The subject directory attributes extension is used to convey
identification attributes (e.g., nationality) of the subject.  The
extension is defined as a sequence of one or more attributes.
Conforming CAs MUST mark this extension as non-critical.

```sql
id-ce-subjectDirectoryAttributes OBJECT IDENTIFIER ::=  { id-ce 9 }
SubjectDirectoryAttributes ::= SEQUENCE SIZE (1..MAX) OF Attribute
```

## Basic Constraints (oid 2.5.29.19)

The basic constraints extension identifies whether the subject of the
certificate is a CA and the maximum depth of valid certification
paths that include this certificate.

- The cA boolean indicates whether the certified public key may be
  used to verify certificate signatures.  If the cA boolean is not
  asserted, then the keyCertSign bit in the key usage extension MUST
  NOT be asserted.  If the basic constraints extension is not present
  in a version 3 certificate, or the extension is present but the cA
  boolean is not asserted, then the certified public key MUST NOT be
  used to verify certificate signatures.
- The pathLenConstraint field is meaningful only if the cA boolean is
  asserted and the key usage extension, if present, asserts the
  keyCertSign bit (Section 4.2.1.3).  In this case, it gives the
  maximum number of non-self-issued intermediate certificates that may
  follow this certificate in a valid certification path.  (Note: The
  last certificate in the certification path is not an intermediate
  certificate, and is not included in this limit.  Usually, the last
  certificate is an end entity certificate, but it can be a CA
  certificate.)
  - A pathLenConstraint of zero indicates that no non- self-issued
    intermediate CA certificates may follow in a valid certification
    path.
  - Where it appears, the pathLenConstraint field MUST be greater than
    or equal to zero.
  - Where pathLenConstraint does not appear, no limit is imposed.  
  - Conforming CAs MUST include this extension in all CA certificates
    that contain public keys used to validate digital signatures on
    certificates and MUST mark the extension as critical in such
    certificates.

```sql
id-ce-basicConstraints OBJECT IDENTIFIER ::=  { id-ce 19 }
                                              -- 2.5.29.19
BasicConstraints ::= SEQUENCE {
  cA                      BOOLEAN DEFAULT FALSE,
  pathLenConstraint       INTEGER (0..MAX) OPTIONAL 
}
```

## Name Constraints (oid 2.5.29.30)

- MUST be used only in a CA certificate
- indicates a name space within which all subject names in subsequent
  certificates in a certification path MUST be located.
- Restrictions apply to:
  - the subject distinguished name and to
  - the subject alternative names
- Restrictions apply only when the specified name form is present
- If no name of the type is in the certificate, the certificate is
  acceptable.
- Name constraints are not applied to self-issued certificates
- Restrictions are defined in terms of permitted or excluded name
  subtrees.
  - For URIs, the constraint applies to the host part of the name.
- If a name constraints extension that is marked as critical
  imposes constraints on a particular name form, and an instance of
  that name form appears in the subject field or subjectAltName
  extension of a subsequent certificate, then the application MUST
  either process the constraint or reject the certificate.

Applications conforming to RFC 5280 profile
- MUST be able to process name constraints that are imposed on the
  - **directoryName** name form
    - When applying restrictions of the form directoryName, an
      implementation MUST compare DN attributes.
- SHOULD be able to process name constraints that are imposed on the:
  - **rfc822Name** name form, 
    - specify a particular mailbox, all addresses at a particular
      host, or all mailboxes in a domain.
      - "example.com" is satisfied by any mail address at the host
        "example.com".
    - To indicate a particular mailbox, the constraint is the complete
      mail address.
      - "root@example.com" indicates the root mailbox on the host
        "example.com".
    - To specify any address within a domain, the constraint is
      specified with a leading period (as with URIs).
      - ".example.com" indicates all the Internet mail addresses in
        the domain "example.com", but not Internet mail addresses on
        the host "example.com".
  - **uniformResourceIdentifier** name form, 
    - ".example.com" => When the constraint begins with a period, it
        MAY be expanded with one or more labels.
  - **dNSName** name form,
    - DNS name restrictions are expressed as host.example.com.  Any
      DNS name that can be constructed by simply adding zero or more
      labels to the left-hand side of the name satisfies the name
      constraint.
      - www.host.example.com would satisfy the constraint
      - host1.example.com would not satisfy the constraint
  - **iPAddress** name form
    - the iPAddress field of GeneralName MUST contain eight (8)
      octets, encoded in the style of RFC 4632 (CIDR) to represent an
      address range [RFC4632].
      - a name constraint for "class C" subnet `192.0.2.0` is
        represented as the octets `C0 00 02 00 FF FF FF 00`,
        representing the CIDR notation `192.0.2.0/24` (mask
        `255.255.255.0`).
    - IPv6 addresses, the iPAddress field MUST contain 32 octets
      similarly encoded.



```sql
id-ce-nameConstraints OBJECT IDENTIFIER ::=  { id-ce 30 }
                                             -- 2.5.29.30
NameConstraints ::= SEQUENCE {
  permittedSubtrees       [0]     GeneralSubtrees OPTIONAL,
  excludedSubtrees        [1]     GeneralSubtrees OPTIONAL 
}

GeneralSubtrees ::= SEQUENCE SIZE (1..MAX) OF GeneralSubtree
GeneralSubtree ::= SEQUENCE {
  base                    GeneralName,
  minimum         [0]     BaseDistance DEFAULT 0,
                          -- 0 is valid value for RFC 5280
  maximum         [1]     BaseDistance OPTIONAL 
                          -- empty value is valid for RFC 5280
}
BaseDistance ::= INTEGER (0..MAX)
```

## Policy Constraints (oid 2.5.29.36)


- The policy constraints extension can be used in certificates issued
  to CAs.
- It can be used to prohibit policy mapping
- It can be used to require that each certificate in a path contain an
  acceptable policy identifier.
- Conforming applications 
  - MUST be able to process the requireExplicitPolicy field and 
  - SHOULD be able to process the inhibitPolicyMapping field.
    Applications that support the inhibitPolicyMapping field 
    - MUST also implement support for the policyMappings extension.  
  - If the policyConstraints extension is marked as critical and the
    inhibitPolicyMapping field is present, applications that do not
    implement support for the inhibitPolicyMapping field MUST reject
    the certificate.


```sql
id-ce-policyConstraints OBJECT IDENTIFIER ::=  { id-ce 36 }
                                               --  2.5.29.36
PolicyConstraints ::= SEQUENCE {
  requireExplicitPolicy     [0] SkipCerts OPTIONAL,
                    -- indicates the number of additional certificates
                    -- that may appear in the path before policy mapping
                    -- is no longer permitted.
  inhibitPolicyMapping      [1] SkipCerts OPTIONAL 
                    -- indicates the number of additional certificates
                    -- that may appear in the path before an explicit 
                    -- policy is required for the entire path.
}
SkipCerts ::= INTEGER (0..MAX)
```

## Extended Key Usage (oid 2.5.29.37)

- This extension indicates one or more purposes for which the
  certified public key may be used, in addition to or in place of the
  basic purposes indicated in the key usage extension.
- In general, this extension will appear only in end entity
  certificates.
- Key purposes may be defined by any organization with a need.
- Object identifiers used to identify key purposes MUST be assigned in
  accordance with IANA or ITU-T Recommendation X.660.
- This extension MAY, at the option of the certificate issuer, be
  either critical or non-critical.
- If the extension is present, then the certificate MUST only be used
  for one of the purposes indicated.  If multiple purposes are
  indicated the application need not recognize all purposes indicated,
  as long as the intended purpose is present.
- Certificate using applications MAY require that the extended key
  usage extension be present and that a particular purpose be
  indicated in order for the certificate to be acceptable to that
  application.
  - If a CA includes extended key usages to satisfy such applications,
    but does not wish to restrict usages of the key, the CA can
    include
    - the special KeyPurposeId **anyExtendedKeyUsage** 
    - in addition to the particular key purposes required by the
      applications.
    - Conforming CAs SHOULD NOT mark this extension as critical if the
      anyExtendedKeyUsage KeyPurposeId is present.
- If a certificate contains both a key usage extension and an extended
  key usage extension, then both extensions MUST be processed
  independently and the certificate MUST only be used for a purpose
  consistent with both extensions.


```sql
id-ce-extKeyUsage OBJECT IDENTIFIER ::= { id-ce 37 }
              -- 2.5.29.37
ExtKeyUsageSyntax ::= SEQUENCE SIZE (1..MAX) OF KeyPurposeId
KeyPurposeId ::= OBJECT IDENTIFIER

anyExtendedKeyUsage OBJECT IDENTIFIER ::= { id-ce-extKeyUsage 0 }
              -- 2.5.29.37.0
id-kp OBJECT IDENTIFIER ::= { id-pkix 3 }
              -- 1.3.6.1.5.5.7.3
              -- {
              --   iso(1) 
              --   identified-organization(3) 
              --   dod(6) 
              --   internet(1) 
              --   security(5) 
              --   mechanisms(5) 
              --   pkix(7) 
              --   kp(3)
              -- }
id-kp-serverAuth    OBJECT IDENTIFIER ::= { id-kp 1 }
              -- 1.3.6.1.5.5.7.3.1
              -- TLS WWW server authentication
              -- Key usage bits that may be consistent: digitalSignature,
              -- keyEncipherment or keyAgreement
id-kp-clientAuth    OBJECT IDENTIFIER ::= { id-kp 2 }
              -- 1.3.6.1.5.5.7.3.2
              -- TLS WWW client authentication
              -- Key usage bits that may be consistent: digitalSignature
              -- and/or keyAgreement
id-kp-codeSigning   OBJECT IDENTIFIER ::= { id-kp 3 }
              -- 1.3.6.1.5.5.7.3.3
              -- Signing of downloadable executable code
              -- Key usage bits that may be consistent: digitalSignature
id-kp-emailProtection OBJECT IDENTIFIER ::= { id-kp 4 }
              -- 1.3.6.1.5.5.7.3.4
              -- Email protection
              -- Key usage bits that may be consistent: digitalSignature,
              -- nonRepudiation, and/or (keyEncipherment or keyAgreement)
id-kp-timeStamping  OBJECT IDENTIFIER ::= { id-kp 8 }
              -- 1.3.6.1.5.5.7.3.8
              -- Binding the hash of an object to a time
              -- Key usage bits that may be consistent: digitalSignature
              -- and/or nonRepudiation
id-kp-OCSPSigning   OBJECT IDENTIFIER ::= { id-kp 9 }
              -- 1.3.6.1.5.5.7.3.9
              -- Signing OCSP responses
              -- Key usage bits that may be consistent: digitalSignature
              -- and/or nonRepudiation
```


## CRL Distribution Points (oid )

The CRL distribution points extension identifies how CRL information
is obtained.  The extension SHOULD be non-critical, but RFC 5280 profile
RECOMMENDS support for this extension by CAs and applications.

- The cRLDistributionPoints extension is a SEQUENCE of
  DistributionPoint.
- A DistributionPoint consists of three fields,
  each of which is optional: 
  - distributionPoint, 
  - reasons
  - cRLIssuer.



```sql
id-ce-cRLDistributionPoints OBJECT IDENTIFIER ::=  { id-ce 31 }
                                -- 2.5.29.31
CRLDistributionPoints ::= SEQUENCE SIZE (1..MAX) OF DistributionPoint
DistributionPoint ::= SEQUENCE {
  distributionPoint       [0]     DistributionPointName OPTIONAL,
  reasons                 [1]     ReasonFlags OPTIONAL,
  cRLIssuer               [2]     GeneralNames OPTIONAL 
}
DistributionPointName ::= CHOICE {
  fullName                [0]     GeneralNames,
  nameRelativeToCRLIssuer [1]     RelativeDistinguishedName 
            -- The value provides a distinguished name fragment.
            --  * The fragment is appended to the X.500 
            --    distinguished name of the CRL issuer to obtain the 
            --    distribution point name.
            --  * If the cRLIssuer field in the DistributionPoint is 
            --    present, then the name fragment is appended to the
            --    distinguished name that it contains; otherwise, 
            --    the name fragment is appended to the certificate 
            --    issuer distinguished name.
            --  * Conforming CAs SHOULD NOT use nameRelativeToCRLIssuer
            --    to specify distribution point names.
}
ReasonFlags ::= BIT STRING {
  unused                  (0),
  keyCompromise           (1),
  cACompromise            (2),
  affiliationChanged      (3),
  superseded              (4),
  cessationOfOperation    (5),
  certificateHold         (6),
  privilegeWithdrawn      (7),
  aACompromise            (8) 
}


```


## Inhibit anyPolicy (oid 2.5.29.54)

- The inhibit anyPolicy extension can be used in certificates issued to
  CAs.
- The inhibit anyPolicy extension indicates that the special anyPolicy
  OID, with the value { 2 5 29 32 0 }, is not considered an explicit
  match for other certificate policies except when it appears in an
  intermediate self-issued CA certificate.
- The value indicates the number of additional non-self-issued
  certificates that may appear in the path before anyPolicy is no
  longer permitted.


```sql
id-ce-inhibitAnyPolicy OBJECT IDENTIFIER ::=  { id-ce 54 }
InhibitAnyPolicy ::= SkipCerts
              -- path length until not allowing anyPolicy
SkipCerts ::= INTEGER (0..MAX)
```

## Freshest CRL (a.k.a. Delta CRL Distribution Point) (oid 2.5.29.46)

The freshest CRL extension identifies how delta CRL information is
obtained.  The extension MUST be marked as non-critical by conforming
CAs.

```sql
id-ce-freshestCRL OBJECT IDENTIFIER ::=  { id-ce 46 }
FreshestCRL ::= CRLDistributionPoints
```

## Private Internet Extensions (oid 2.5.29.)

This section defines two extensions for use in the Internet Public
Key Infrastructure.  These extensions may be used to direct
applications to on-line information about the issuer or the subject.
Each extension contains a sequence of access methods and access
locations.  The access method is an object identifier that indicates
the type of information that is available.  The access location is a
GeneralName that implicitly specifies the location and format of the
information and the method for obtaining the information.

Object identifiers are defined for the private extensions.  The
object identifiers associated with the private extensions are defined
under the arc id-pe within the arc id-pkix.  Any future extensions
defined for the Internet PKI are also expected to be defined under
the arc id-pe.

Extensions:
- Authority Information Access
- Subject Information Access

```sql
-- top:
id-pkix  OBJECT IDENTIFIER  ::=
          { iso(1) identified-organization(3) dod(6) internet(1)
                  security(5) mechanisms(5) pkix(7) }
id-pe  OBJECT IDENTIFIER  ::=  { id-pkix 1 }

-- authorityInfoAccess:
id-pe-authorityInfoAccess OBJECT IDENTIFIER ::= { id-pe 1 }
AuthorityInfoAccessSyntax  ::=
        SEQUENCE SIZE (1..MAX) OF AccessDescription
AccessDescription  ::=  SEQUENCE {
        accessMethod          OBJECT IDENTIFIER,
        accessLocation        GeneralName  }
id-ad OBJECT IDENTIFIER ::= { id-pkix 48 }
id-ad-caIssuers OBJECT IDENTIFIER ::= { id-ad 2 }
id-ad-ocsp OBJECT IDENTIFIER ::= { id-ad 1 }

-- subjectInfoAccess:
id-pe-subjectInfoAccess OBJECT IDENTIFIER ::= { id-pe 11 }
SubjectInfoAccessSyntax  ::=
        SEQUENCE SIZE (1..MAX) OF AccessDescription
AccessDescription  ::=  SEQUENCE {
        accessMethod          OBJECT IDENTIFIER,
        accessLocation        GeneralName  }
```


# Some info of URIs

https://tools.ietf.org/html/rfc3986

```
  foo://example.com:8042/over/there?name=ferret#nose
  \_/   \______________/\_________/ \_________/ \__/
  |           |            |            |        |
scheme     authority       path        query   fragment
  |   _____________________|__
  / \ /                        \
  urn:example:animal:ferret:nose
```

## URI

```
URI         = scheme ":" hier-part [ "?" query ] [ "#" fragment ]
hier-part   = "//" authority path-abempty
            / path-absolute
            / path-rootless
            / path-empty
```

## Scheme

Scheme begins and names used scheme until ":".

```
scheme      = ALPHA *( ALPHA / DIGIT / "+" / "-" / "." )
```

## Authority

Authority (who owns) is between "//" and "/"

```
//authority/
authority   = [ userinfo "@" ] host [ ":" port ]
userinfo    = *( unreserved / pct-encoded / sub-delims / ":" )
host        = IP-literal / IPv4address / reg-name
port        = *DIGIT

reg-name    = *( unreserved / pct-encoded / sub-delims )

IPv6address =                            6( h16 ":" ) ls32
            /                       "::" 5( h16 ":" ) ls32
            / [               h16 ] "::" 4( h16 ":" ) ls32
            / [ *1( h16 ":" ) h16 ] "::" 3( h16 ":" ) ls32
            / [ *2( h16 ":" ) h16 ] "::" 2( h16 ":" ) ls32
            / [ *3( h16 ":" ) h16 ] "::"    h16 ":"   ls32
            / [ *4( h16 ":" ) h16 ] "::"              ls32
            / [ *5( h16 ":" ) h16 ] "::"              h16
            / [ *6( h16 ":" ) h16 ] "::"
ls32        = ( h16 ":" h16 ) / IPv4address
            ; least-significant 32 bits of address
h16         = 1*4HEXDIG
            ; 16 bits of address represented in hexadecimal

IPv4address = dec-octet "." dec-octet "." dec-octet "." dec-octet
dec-octet   = DIGIT                 ; 0-9
            / %x31-39 DIGIT         ; 10-99
            / "1" 2DIGIT            ; 100-199
            / "2" %x30-34 DIGIT     ; 200-249
            / "25" %x30-35          ; 250-255
```

## Path

```
path          = path-abempty    ; begins with "/" or is empty
              / path-absolute   ; begins with "/" but not "//"
              / path-noscheme   ; begins with a non-colon segment
              / path-rootless   ; begins with a segment
              / path-empty      ; zero characters

path-abempty  = *( "/" segment )
path-absolute = "/" [ segment-nz *( "/" segment ) ]
path-noscheme = segment-nz-nc *( "/" segment )
path-rootless = segment-nz *( "/" segment )
path-empty    = 0<pchar>
segment       = *pchar
segment-nz    = 1*pchar
segment-nz-nc = 1*( unreserved / pct-encoded / sub-delims / "@" )
              ; non-zero-length segment without any colon ":"
pchar         = unreserved / pct-encoded / sub-delims / ":" / "@"

```

## Query

```
query       = *( pchar / "/" / "?" )
```

## Fragment

```
fragment    = *( pchar / "/" / "?" )

```


# Policies, what is this fuss about???


> In order to stay conformant with RFC5280, any certificate policy must
> be valid for entire certification path (or certificate chain). 4 main
> rules apply when processing certificate policies extension:
> 
> 1. Certificate Policies extension must appear in all certificates in
>    the chain except root certificate.
> 2. Object Identifiers are not inheritable. This means that tow OIDs:
>    1.3.6.1.4.1.9999.1 and 1.3.6.1.4.1.9999.1.1 are different
>    identifiers and they do not match each other (although, they share
>    the same OID namespace).
> 3. Certificate policy OID presented in leaf certificate must be valid
>    for entire certification path.
> 4. If Certificate Policies extension is missing in the CA certificate,
>    no explicit certificate policies are allowed below that CA
>    certificate.
> 
> First, why root CA certificate don’t need to have a Certificate
> Policies extension? It is because an implicit Certificate Policies
> extension with wildcard “All Issuance Policies” is implied for
> self-signed certificates. And no custom policies shall be defined at
> root level. Certificate Policies extension must appear at 2nd level
> (Policy CA in a 3-tier hierarchy, or Issuing CA when Policy and
> Issuing CA roles are combined in a 2-tier hierarchy).
> 
> For example, Certificate Policies appearance in a 3-tier hierarchy:
> 
> ```
> Root CA – no CP extension
>   Policy CA – CP extension with one or more policies
>     Issuing CA – CP extension with one or more policies
>       Leaf certificate – CP extension with one or more policies
> ```
> 
> In a 2-tier hierarchy, the path is shorter, but the same rules apply:
> 
> ```
> Root CA – no CP extension
>   Issuing CA – CP extension with one or more policies
>     Leaf certificate – CP extension with one or more policies
> ```
> 
> Remember that these configurations are invalid:
> 
> ```
> Root CA – no CP extension
>   Policy CA – CP extension with one or more policies
>     Issuing CA – no CP extension
>       Leaf certificate – CP extension with one or more policies
> 
> Root CA – no CP extension
>   Issuing CA – no CP extension
>     Leaf certificate – CP extension with one or more policies
> ```
> Cite from: 
https://www.sysadmins.lv/blog-en/certificate-policies-extension-all-you-should-know-part-1.aspx


# Shortest PKI possible

https://developer.mozilla.org/en-US/docs/Mozilla/Security/x509_Certificates


# Simple Root PKI

Root Certificate:
- must be CA
- must have subject key ID
- must have common name = localhost
- must use specified key file

Configuration:

```conf
[ default ]
dir     = . # current dir
keyfile = dev-localhost.core.key

[ req ]
                        # request parameters:
prompt                  = no                    
                        # Don't prompt for DN
default_md              = sha1                  
                        # Digest alg to use for certificate digest
                        # (specified in req used by ca if ok)
utf8                    = yes                   
                        # Interpret input as UTF-8
string_mask             = utf8only              
                        # Emit UTF-8 strings (RFC 5280 Recommended)
distinguished_name      = dn                    
                        # DN section
x509_extensions          = x509_ext            
                        # section pointer to extensions to be added
                        # to certificate generated when the -x509 switch is used

[ dn ]
commonName              = localhost
                        # only this

[ x509_ext ]
# 
# keyUsage                = critical,keyCertSign,cRLSign
                        # this should not be required
basicConstraints        = critical,CA:true
                        # this should be certificate of CA
subjectKeyIdentifier    = hash
                        # this is RFC5280 profile Must for CA

```

Production:

```sh
openssl req -x509 \
  -config localhost_root.conf \
  -key hack/dev-localhost.core.key \
  -out localhost_root.pem
```

Usage:

```sh
openssl x509 -text -in localhost_root.pem 
```



# Root and CA for ASP.Net Core server PKI

## Selfsign root cert config


```conf

[default]                     
                    # names in [default] can be referenced as:
                    #  * $default::dir_to_put_certs
                    #  * $dir_to_put_certs
dir_to_put_certs    = ./root
signing_cert_file   = ./root/localhost_root.pem
signing_priv_key    = ./root/localhost_root.key 
serial_file         = ./root/localhost_root.srl 
database_file       = ./root/localhost_root.db 

# default_ca        = root_ca
                    # section pointer for 'openssl ca ...'
                    # configuration, it can be specified
                    # in [default] or [ca] or using
                    # 'openssl ca -name root_ca

[ req ]                         
                    # request parameters:
default_md          = sha256                  
                    # MD to use
utf8                = yes                   
                    # Input is UTF-8
string_mask         = utf8only              
                    # Emit UTF-8 strings
prompt              = no                    
                    # Don't prompt for DN
distinguished_name  = dn                    
                    # DN section
req_extensions      = req_ext            
                    # request extensions section

[ dn ]                        
commonName          = localhost root


[ req_ext ]
# keyUsage            = critical,keyCertSign,cRLSign
                      # this should not be required
basicConstraints      = critical,CA:true
                      # this should be certificate of CA
subjectKeyIdentifier  = hash
                      # this is RFC5280 profile Must for CA


[ ca ]                      
                # this certificate certification parameters:
default_ca      = cert_issuing_parameters               
                # section pointer for 'openssl ca ...'
                # configuration, it can be specified
                # in [default] or [ca] or using
                # 'openssl ca -name cert_issuing_parameters ...'
[ cert_issuing_parameters ]     
                # https://www.openssl.org/docs/man1.1.1/man1/ca.html
new_certs_dir   = $dir_to_put_certs
                # MANDATORY 
                # where signed certs will be
certificate     = $signing_cert_file
                # MANDATORY 
                # (it does not exist for -selfsign)
                # CA certificate used for signing CSRs
private_key     = $signing_priv_key
                # MANDATORY
                # private key of this CA
serial          = $serial_file
                # MANDATORY
                # file containing serial number
database        = $database_file
                # MANDATORY
                # The text database file to use.
                # initially it will be empty
policy          = any_pol
                # MANDATORY
                # pointer to section
                # The policy section consists of a set of variables 
                # corresponding to certificate DN fields.
                #  * Any fields not mentioned in the policy section 
                #    are silently deleted
                #  * policy DN filds can have values:
                #    * match - the field value must match the same 
                #      field in the CA certificate, 
                #      (=> this:DN:component = request:DN:component)
                #      for this CA cert for egzample :
                #        if 
                #          this:commonName = match 
                #        then 
                #          request:commonName = localhost
                #    * supplied (=> request:DN:component = something)
                #    * optional (=> request:DN:component = [something])
default_md      = sha256
                # MANDATORY (but probably taken from req if not present)
                # digest algorithm selector for cert digest



default_days    = 3652                  
                # (about 10 years)
                # The number of days to certify a certificate for.
default_startdate = 20200101010000Z
                # ( 2020 01 01 01 00 00 Z(=>GMT) )
                # format: YYYYMMDDHHMMSSZ
                # seconds SS and timezone Z must be present

copy_extensions = copy                  
                # Copy extensions from CSR?
                #  * none - If set to none or this option is not present then 
                #    extensions are ignored and not copied to the certificate.
                #  * copy - any extensions present in the request that are not
                #    already present are copied to the certificate.
                #  * copyall - all extensions in the request are copied to the
                #    certificate: if the extension is already present in the 
                #    certificate it is deleted first.
x509_extensions = signed_certs_extensions           
                # for signing typically specialised configuration 
                # would be used


unique_subject  = no
                # do valid certificate entries in the database 
                # must have unique subjects?
                # (usefull for roll-over of -selfsign certs)
email_in_dn     = no
                # allow for the EMAIL filed in the certificate's DN?
                # RFC5280 recomends no
preserve        = no                    
                # should keep passed DN ordering?
name_opt        = ca_default
                # ca_default is default value for printing
                # Subject DN display options
cert_opt        = no_header,no_version,no_serial,no_signame,no_validity,no_subject,no_issuer,no_pubkey,no_sigdump,no_aux,no_extensions
                # Certificate display options
                # ca_default is default value for printing


[ any_pol ]
                        # Naming policies control which parts of  
                        # a DN end up in the certificate and
                        # under what circumstances certification 
                        # should be denied.
domainComponent         = optional
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = optional
emailAddress            = optional



[ signed_certs_extensions ]
                        # Certificate extensions define what types 
                        # of certificates the CA is able to create.
                        # This config is used for selfsign so only those:
basicConstraints        = critical,CA:true
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid
                        # This cannot be in request extensions because
                        # when requesting it is not what key will sign.
                        # * keyid - an attempt is made to copy the subject
                        #   key identifier from the parent certificate.
                        #    * keyid:always - error can be returned if the 
                        #      option fails
                        # * issuer - an attempt is made to copy the issuer and
                        #   serial number from the parent certificate.
                        #    * This is done if the keyid option fails, or
                        #    * issuer has always specified
```

## CA cert config

```conf
[default]                     
                    # names in [default] can be referenced as:
                    #  * $default::dir_to_put_certs
                    #  * $dir_to_put_certs
dir_to_put_certs    = ./ca
signing_cert_file   = ./ca/localhost_ca.pem
signing_priv_key    = ./hack/dev-localhost.core.key 
serial_file         = ./ca/localhost_ca.srl 
database_file       = ./ca/localhost_ca.db 

[ req ]                         
                    # request parameters:
default_md          = sha256
                    # MD to use
utf8                = yes                   
                    # Input is UTF-8
string_mask         = utf8only              
                    # Emit UTF-8 strings
prompt              = no                    
                    # Don't prompt for DN
distinguished_name  = dn                    
                    # DN section
req_extensions      = req_ext            
                    # request extensions section

[ dn ]                        
commonName          = localhost

[ req_ext ]
basicConstraints      = critical,CA:true
                      # this should be CA certificate
keyUsage              = critical,keyCertSign
                      # required cert can be used for: 
                      #  * signing certificates
# certificatePolicies   = 1.3.6.1.4.1.311.84.1.1
                      # Policies is agreement that cert have something.
                      # To be consistent all certs in chain (except root)
                      # must have it.
                      # 1.3.6.1.4.1.311.84.1.1 policy is checked by Kestrel 
                      # server to accept certificate as its own certificate
1.3.6.1.4.1.311.84.1.1 = DER:01
subjectKeyIdentifier  = hash
                      # RFC5280 compilant CA cert must have this


[ ca ]                      
                # this certificate certification parameters:
default_ca      = cert_issuing_parameters               
                # section pointer for 'openssl ca ...'
                # configuration, it can be specified
                # in [default] or [ca] or using
                # 'openssl ca -name root_ca

[ cert_issuing_parameters ]     
                # https://www.openssl.org/docs/man1.1.1/man1/ca.html
new_certs_dir   = $dir_to_put_certs
                # MANDATORY 
                # where signed certs will be
certificate     = $signing_cert_file
                # MANDATORY 
                # (it does not exist for -selfsign)
                # CA certificate used for signing CSRs
private_key     = $signing_priv_key
                # MANDATORY
                # private key of this CA
serial          = $serial_file
                # MANDATORY
                # file containing serial number
database        = $database_file
                # MANDATORY
                # The text database file to use.
                # initially it will be empty
policy          = any_pol
                # MANDATORY
                # pointer to section
                # The policy section consists of a set of variables 
                # corresponding to certificate DN fields.
                #  * Any fields not mentioned in the policy section 
                #    are silently deleted
                #  * policy DN filds can have values:
                #    * match - the field value must match the same 
                #      field in the CA certificate, 
                #      (=> this:DN:component = request:DN:component)
                #      for this CA cert for egzample :
                #        if 
                #          this:commonName = match 
                #        then 
                #          request:commonName = localhost
                #    * supplied (=> request:DN:component = something)
                #    * optional (=> request:DN:component = [something])
default_md      = sha256
                # MANDATORY (but probably taken from req if not present)
                # digest algorithm selector for cert digest


default_startdate = 20200714001526Z
                # ( 2020 01 01 01 00 00 Z(=>GMT) )
                # format: YYYYMMDDHHMMSSZ
                # seconds SS and timezone Z must be present
default_enddate  = 20210714001526Z
                # MUST exist if default_days not exist
# default_days    = 365
                # MUST exist if default_enddate not exist
                # (about 1 year)
                # The number of days to certify a certificate for.
copy_extensions = copy
                # Copy extensions from CSR?
                #  * none - If set to none or this option is not present then 
                #    extensions are ignored and not copied to the certificate.
                #  * copy - any extensions present in the request that are not
                #    already present are copied to the certificate.
                #  * copyall - all extensions in the request are copied to the
                #    certificate: if the extension is already present in the 
                #    certificate it is deleted first.
x509_extensions = signed_certs_extensions
                # for signing typically specialised configuration 
                # would be used

unique_subject  = no
                # do valid certificate entries in the database 
                # must have unique subjects?
                # (usefull for roll-over of -selfsign certs)
email_in_dn     = no
                # allow for the EMAIL filed in the certificate's DN?
                # RFC5280 recomends no
preserve        = no                    
                # should keep passed DN ordering?
name_opt        = ca_default
                # ca_default is default value for printing
                # Subject DN display options
cert_opt        = no_header,no_version,no_serial,no_signame,no_validity,no_subject,no_issuer,no_pubkey,no_sigdump,no_aux,no_extensions
                # Certificate display options
                # ca_default is default value for printing

[ any_pol ]
                        # Naming policies control which parts of  
                        # a DN end up in the certificate and
                        # under what circumstances certification 
                        # should be denied.
domainComponent         = optional
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = optional
emailAddress            = optional

[ signed_certs_extensions ]
                        # Certificate extensions define what types 
                        # of certificates the CA is able to create.
                        # This config is used for selfsign so only those:
basicConstraints        = critical,CA:false
# certificatePolicies     = 1.3.6.1.4.1.311.84.1.1
                        # Policies is agreement that cert have something.
                        # To be consistent all certs in chain (except root)
                        # must have it.
                        # 1.3.6.1.4.1.311.84.1.1 policy is checked by Kestrel 
                        # server to accept certificate as its own certificate
# 1.3.6.1.4.1.311.84.1.1 = ASN1:UTF8String:.
```

## ASP.Net Core server dev certif config

Request and sign config:

```conf
[ req ]                         
                    # request parameters:
default_md          = sha256
                    # MD to use
utf8                = yes                   
                    # Input is UTF-8
string_mask         = utf8only              
                    # Emit UTF-8 strings
prompt              = no                    
                    # Don't prompt for DN
distinguished_name  = dn                    
                    # DN section
req_extensions      = req_ext            
                    # request extensions section

[ dn ]                        
commonName          = localhost

[ req_ext ]
basicConstraints      = critical,CA:false
                      # this should be end user certificate
keyUsage              = critical,digitalSignature,keyEncipherment
                      # required cert can be used for: 
                      #  * signing (but not certificates or revocation lists)
                      #  * encryption (but only of keys)
extendedKeyUsage      = critical,serverAuth
                      # used for: TLS Web Server Authentication
subjectAltName        = critical,@req_alt_section
                      # DNS of certificate for development should be localhost
# certificatePolicies   = 1.3.6.1.4.1.311.84.1.1
                      # this is policy which is checked by Kestrel server
                      # to accept certificate as its own certificate
1.3.6.1.4.1.311.84.1.1 = DER:01


[ req_alt_section ]
DNS.1                 = localhost
```


## Certificates generation

Script to generate certificates:

```sh
#!/bin/sh

set -e

clear
clear

rm -f -r root ca

# directory for root certificate and issued certificates
mkdir -p root
# root private key
if [ ! -f root/localhost_root.key ];
then
openssl genpkey -algorithm RSA \
    -pkeyopt rsa_keygen_bits:4096 \
    -out root/localhost_root.key
fi

# certificates signing history,
# every signing must have unique 
# hex number, lets start with 01
# File with SN is needed for 'openssl ca ...' command
if [ ! -f root/localhost_root.srl ]; 
then 
echo 01 > root/localhost_root.srl; 
fi

# empty file to store signed certificates info
# is needed for 'openssl ca ...' command
if [ ! -f root/localhost_root.db ]; 
then 
cp /dev/null root/localhost_root.db; 
fi

# attr file is not needed for 'openssl ca ...' command
# (it holds only 'unique_subject = yes/no' value)
# this file is undocumented on openssl :(
# but on errors its lack adds error message to cause errors
# if [ ! -f localhost_root.db.attr ] 
# then 
# cp /dev/null localhost_root.db.attr ;
# fi 

# request of root selfsign cert
if [ ! -f root/selfsign_localhost_root.csr ]; 
then
openssl req -new -batch \
    -config conf/selfsign_localhost_root.conf \
    -key    root/localhost_root.key \
    -out    root/selfsign_localhost_root.csr
fi

# lets check root selfsign cert request file
echo "****************************************"
echo "root/selfsign_localhost_root.csr"
echo "****************************************"
openssl req -text -noout -in root/selfsign_localhost_root.csr 
echo "****************************************"

# selfsign root ca sign request
if [ ! -f root/localhost_root.pem ]; 
then
openssl ca -selfsign -batch \
    -config conf/selfsign_localhost_root.conf \
    -in root/selfsign_localhost_root.csr \
    -out root/localhost_root.pem
fi

# lets check root cert file
echo "****************************************"
echo "root/localhost_root.pem "
echo "****************************************"
openssl x509 -text -noout -in root/localhost_root.pem 
echo "****************************************"

# ca cert directory:
mkdir -p ca

# ca issued certs SNs:
if [ ! -f ca/localhost_ca.srl ]; 
then 
# Wanted Serial Number: 
# 5747736622853871796 (0x4fc4100173b558b4)
echo 4fc4100173b558b4 > ca/localhost_ca.srl
fi

# ca issued certs db:
if [ ! -f ca/localhost_ca.db ]; then cp /dev/null ca/localhost_ca.db ; fi

# request of ca certificate
if [ ! -f ca/localhost_ca.csr ]; 
then
openssl req -new -batch \
    -config conf/localhost_ca.conf \
    -key    hack/dev-localhost.core.key \
    -out    ca/localhost_ca.csr
fi

# lets check ca cert request file
echo "****************************************"
echo "ca/localhost_ca.csr "
echo "****************************************"
openssl req -text -noout -in ca/localhost_ca.csr 
echo "****************************************"

# root sign ca certificate request
if [ ! -f ca/localhost_ca.pem ]; 
then
openssl ca -batch \
    -config conf/selfsign_localhost_root.conf \
    -in     ca/localhost_ca.csr \
    -out    ca/localhost_ca.pem
fi

# lets check ca cert file
echo "****************************************"
echo "ca/localhost_ca.pem "
echo "****************************************"
openssl x509 -text -noout -in ca/localhost_ca.pem 
echo "****************************************"

# request of hacked certificate
if [ ! -f ca/localhost_hacked.csr ]; 
then
openssl req -new -batch \
    -config conf/localhost_hacked.conf \
    -key    hack/dev-localhost.core.key \
    -out    ca/localhost_hacked.csr
fi

# lets check hacked cert request file
echo "****************************************"
echo "ca/localhost_hacked.csr "
echo "****************************************"
openssl req -text -noout -in ca/localhost_hacked.csr 
echo "****************************************"

# ca sign ca certificate request
if [ ! -f ca/localhost_hacked.pem ]; 
then
openssl ca -batch \
    -config conf/localhost_ca.conf \
    -in     ca/localhost_hacked.csr \
    -out    ca/localhost_hacked.pem
fi

# lets check hacked cert file
echo "****************************************"
echo "ca/localhost_hacked.pem "
echo "****************************************"
openssl x509 -text -noout -in ca/localhost_hacked.pem 
echo "****************************************"
```

Usage:

```console
root_ca_pki$ sh conf/build_pki.sh
```